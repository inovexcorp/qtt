<mat-card appearance="outlined" class="config-panel">
  <div class="datasource-card-header">
    <h1 class="card-header">{{ dataSourceId }}</h1>
    <button class="delete-datasource" (click)="openConfirmDeleteDatasourceModal()" mat-icon-button>
      <mat-icon>delete</mat-icon>
    </button>
  </div>
  <mat-tab-group class="remove-border-bottom" mat-stretch-tabs animationDuration="500ms">
    <mat-tab label="Config">
      <div class="example-spacer"></div>

      <!-- Health Status Section -->
      <div class="health-status-section">
        <div class="status-display">
          <span class="status-label">Health Status:</span>
          <div class="status-badge-large"
               [class]="getStatusClass(datasourceStatus)">
            <mat-icon>{{getStatusIcon(datasourceStatus)}}</mat-icon>
            <span class="status-text">{{datasourceStatus || 'UNKNOWN'}}</span>
          </div>
        </div>
        <div class="health-actions">
          <button mat-raised-button
                  color="primary"
                  [disabled]="isEnabling || datasourceStatus === 'UP' || datasourceStatus === 'CHECKING'"
                  (click)="enableDatasource()">
            <mat-icon>play_arrow</mat-icon>
            <span *ngIf="!isEnabling">Enable</span>
            <span *ngIf="isEnabling">Enabling...</span>
          </button>

          <button mat-raised-button
                  color="warn"
                  [disabled]="isDisabling || datasourceStatus === 'DISABLED'"
                  (click)="disableDatasource()">
            <mat-icon>block</mat-icon>
            <span *ngIf="!isDisabling">Disable</span>
            <span *ngIf="isDisabling">Disabling...</span>
          </button>

          <button mat-raised-button
                  color="accent"
                  [disabled]="datasourceStatus === 'DISABLED' || datasourceStatus === 'CHECKING'"
                  (click)="triggerHealthCheck()">
            <mat-icon>refresh</mat-icon>
            Check Now
          </button>
        </div>
      </div>

      <mat-divider></mat-divider>

      <form [formGroup]="configDatasource">
        <div>
          <mat-form-field class="config-datasource-form-field" appearance="outline">
            <mat-label>URL</mat-label>
            <input type="text" matInput formControlName="url">
            <mat-icon matSuffix>link</mat-icon>
            <mat-error *ngIf="url && url.invalid && url.touched">Require a URL</mat-error>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="config-datasource-form-field" appearance="outline">
            <mat-label>Time Out Seconds</mat-label>
            <input height="50rem" matInput formControlName="timeOutSeconds">
            <mat-icon matSuffix>timelapse</mat-icon>
            <mat-error *ngIf="timeOutSeconds && timeOutSeconds.invalid && timeOutSeconds.touched">Require a
              TimeOutSeconds number
            </mat-error>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="config-datasource-form-field" appearance="outline">
            <mat-label>Max Query Header Length</mat-label>
            <input matInput formControlName="maxQueryHeaderLength">
            <mat-icon matSuffix>settings_ethernet</mat-icon>
            <mat-error *ngIf="maxQueryHeaderLength && maxQueryHeaderLength.invalid && maxQueryHeaderLength.touched">
              Require a Max Query Header Length
            </mat-error>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="config-datasource-form-field" appearance="outline">
            <mat-label>Username</mat-label>
            <input matInput formControlName="username">
            <mat-icon matSuffix>account_circle</mat-icon>
            <mat-error *ngIf="username && username.invalid && username.touched">Require a Username</mat-error>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="config-datasource-form-field" appearance="outline">
            <mat-label>Password</mat-label>
            <input matInput [type]="hide ? 'password' : 'text'" formControlName="password">
            <mat-icon matSuffix (click)="hide = !hide">{{ hide ? 'visibility_off' : 'visibility' }}</mat-icon>
            <mat-error *ngIf="password && password.invalid && password.touched">Require a Password</mat-error>
          </mat-form-field>
        </div>
        <div>
          <mat-form-field class="config-datasource-form-field" appearance="outline">
            <mat-label>Validate HTTPS Certificates</mat-label>
            <mat-select formControlName="validateCertificate">
              <mat-option value="true">
                <mat-icon>key</mat-icon>
                Validate Certificates
              </mat-option>
              <mat-option value="false">
                <mat-icon>key_off</mat-icon>
                Ignore Certificates
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </form>
      <button type="submit" [disabled]="!configDatasource.valid" mat-raised-button color="primary" id="submit-button"
              (click)="config(dataSourceId); "><mat-icon>check</mat-icon>Submit
      </button>
      <button type="button" [disabled]="!configDatasource.valid" mat-raised-button color="accent" id="test-button"
              (click)="test()"><mat-icon>network_check</mat-icon>Test
      </button>
      <div *ngIf="testResponseStatus" class="test-response" [ngClass]="{
          'success': testResponseStatus === 'success',
          'error': testResponseStatus === 'error'
        }">
        <div *ngIf="testResponseStatus === 'success'">
          Connection successful!
          <pre *ngIf="testResponse">{{ testResponse | json }}</pre>
        </div>
        <div *ngIf="testResponseStatus === 'error'">
          Connection failed!
          <pre *ngIf="testResponse">{{ testResponse | json }}</pre>
        </div>
      </div>
    </mat-tab>
    <mat-tab label="Usage">
      <div class="usage-tab-content">
        <div *ngIf="isLoadingMetrics" class="loading-container">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <p>Loading metrics...</p>
        </div>

        <div *ngIf="!isLoadingMetrics" class="metrics-container">
          <!-- Aggregate Metrics Cards -->
          <div class="aggregate-metrics">
            <mat-card class="metric-card">
              <mat-card-header>
                <mat-card-title>Total Routes</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="metric-value">{{ aggregateMetrics.totalRoutes }}</div>
                <div class="metric-label">routes using this datasource</div>
              </mat-card-content>
            </mat-card>

            <mat-card class="metric-card">
              <mat-card-header>
                <mat-card-title>Total Exchanges</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="metric-value">{{ aggregateMetrics.totalExchanges }}</div>
                <div class="metric-label">total processed</div>
              </mat-card-content>
            </mat-card>

            <mat-card class="metric-card">
              <mat-card-header>
                <mat-card-title>Avg Latency</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="metric-value">{{ aggregateMetrics.avgLatency }}ms</div>
                <div class="metric-label">average processing time</div>
              </mat-card-content>
            </mat-card>

            <mat-card class="metric-card">
              <mat-card-header>
                <mat-card-title>Success Rate</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="metric-value">{{ aggregateMetrics.successRate }}%</div>
                <div class="metric-label">exchanges completed</div>
              </mat-card-content>
            </mat-card>

            <mat-card class="metric-card">
              <mat-card-header>
                <mat-card-title>Failed Exchanges</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="metric-value">{{ aggregateMetrics.failedExchanges }}</div>
                <div class="metric-label">total failed</div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Routes Table -->
          <div class="routes-table-container">
            <div class="table-header">
              <h3>Routes Using This Datasource ({{ routeMetrics.length }} total)</h3>
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Search routes</mat-label>
                <input #filterInput matInput (keyup)="applyRouteFilter(filterInput.value)" placeholder="Filter by route name, state, etc.">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>
            </div>

            <table mat-table [dataSource]="routeMetricsDataSource" matSort class="mat-elevation-z8">
              <!-- Route Name Column -->
              <ng-container matColumnDef="route">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Route</th>
                <td mat-cell *matCellDef="let metric">{{ metric.route }}</td>
              </ng-container>

              <!-- State Column -->
              <ng-container matColumnDef="state">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>State</th>
                <td mat-cell *matCellDef="let metric">
                  <span [ngClass]="{'state-started': metric.state === 'Started', 'state-stopped': metric.state === 'Stopped'}">
                    {{ metric.state }}
                  </span>
                </td>
              </ng-container>

              <!-- Processing Time Column -->
              <ng-container matColumnDef="processingTime">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Processing Time (Min/Avg/Max)</th>
                <td mat-cell *matCellDef="let metric">
                  {{ metric.minProcessingTime }}ms / {{ metric.meanProcessingTime }}ms / {{ metric.maxProcessingTime }}ms
                </td>
              </ng-container>

              <!-- Total Exchanges Column -->
              <ng-container matColumnDef="exchanges">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Exchanges</th>
                <td mat-cell *matCellDef="let metric">
                  <span class="success-count">{{ metric.exchangesCompleted }} completed</span> /
                  <span class="failed-count">{{ metric.exchangesFailed }} failed</span>
                </td>
              </ng-container>

              <!-- Uptime Column -->
              <ng-container matColumnDef="uptime">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Uptime</th>
                <td mat-cell *matCellDef="let metric">{{ metric.uptime }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>

            <mat-paginator
              #paginator
              [pageSize]="10"
              [pageSizeOptions]="[5, 10, 25, 50]"
              [showFirstLastButtons]="true"
              aria-label="Select page of routes">
            </mat-paginator>

            <div *ngIf="routeMetrics.length === 0" class="no-routes-message">
              <mat-icon>info</mat-icon>
              <p>No routes are currently using this datasource.</p>
            </div>
          </div>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
  <div></div>
</mat-card>
