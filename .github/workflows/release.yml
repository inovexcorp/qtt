name: Maven Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    name: Maven Release and Tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Configure Git to use HTTPS with token
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Get current version
        id: current-version
        run: |
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Check if version is SNAPSHOT
        id: check-snapshot
        run: |
          VERSION="${{ steps.current-version.outputs.version }}"
          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            echo "is_snapshot=true" >> $GITHUB_OUTPUT
            echo "Version $VERSION is a SNAPSHOT, proceeding with release"
          else
            echo "is_snapshot=false" >> $GITHUB_OUTPUT
            echo "Version $VERSION is not a SNAPSHOT, skipping release"
          fi

      - name: Generate changelog
        if: steps.check-snapshot.outputs.is_snapshot == 'true'
        id: changelog
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No previous tags found, generating changelog from first commit"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog since tag: $LATEST_TAG"
            CHANGELOG=$(git log ${LATEST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Save changelog to file
          echo "## Changes" > CHANGELOG.tmp.md
          echo "" >> CHANGELOG.tmp.md
          if [ -z "$CHANGELOG" ]; then
            echo "- No changes since last release" >> CHANGELOG.tmp.md
          else
            echo "$CHANGELOG" >> CHANGELOG.tmp.md
          fi

          cat CHANGELOG.tmp.md
          echo "changelog_file=CHANGELOG.tmp.md" >> $GITHUB_OUTPUT

      - name: Maven Release Prepare and Perform
        if: steps.check-snapshot.outputs.is_snapshot == 'true'
        run: |
          mvn -B release:prepare release:perform \
            -Pgithub-release \
            -DskipTests \
            -Darguments="-DskipTests"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release version
        if: steps.check-snapshot.outputs.is_snapshot == 'true'
        id: release-version
        run: |
          # The release plugin creates a tag, get the latest one
          RELEASE_TAG=$(git describe --tags --abbrev=0)
          RELEASE_VERSION=${RELEASE_TAG#v}
          echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "Release tag: $RELEASE_TAG"
          echo "Release version: $RELEASE_VERSION"

      - name: Find release artifacts
        if: steps.check-snapshot.outputs.is_snapshot == 'true'
        id: artifacts
        run: |
          # Find the distribution tar.gz and zip files
          DIST_TAR=$(find query-service-distribution/target -name "*.tar.gz" -type f | head -n 1)
          DIST_ZIP=$(find query-service-distribution/target -name "*.zip" -type f | head -n 1)

          echo "tar_file=$DIST_TAR" >> $GITHUB_OUTPUT
          echo "zip_file=$DIST_ZIP" >> $GITHUB_OUTPUT

          if [ -n "$DIST_TAR" ]; then
            echo "Found tar.gz: $DIST_TAR"
          fi
          if [ -n "$DIST_ZIP" ]; then
            echo "Found zip: $DIST_ZIP"
          fi

      - name: Create GitHub Release
        if: steps.check-snapshot.outputs.is_snapshot == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="${{ steps.release-version.outputs.tag }}"
          CHANGELOG_FILE="${{ steps.changelog.outputs.changelog_file }}"

          # Create release with changelog
          gh release create "$RELEASE_TAG" \
            --title "Release $RELEASE_TAG" \
            --notes-file "$CHANGELOG_FILE"

          # Upload artifacts if they exist
          TAR_FILE="${{ steps.artifacts.outputs.tar_file }}"
          ZIP_FILE="${{ steps.artifacts.outputs.zip_file }}"

          if [ -n "$TAR_FILE" ] && [ -f "$TAR_FILE" ]; then
            echo "Uploading $TAR_FILE"
            gh release upload "$RELEASE_TAG" "$TAR_FILE"
          fi

          if [ -n "$ZIP_FILE" ] && [ -f "$ZIP_FILE" ]; then
            echo "Uploading $ZIP_FILE"
            gh release upload "$RELEASE_TAG" "$ZIP_FILE"
          fi

      - name: Release Summary
        if: always()
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-snapshot.outputs.is_snapshot }}" == "true" ]; then
            echo "- **Status**: Release completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "- **Original Version**: ${{ steps.current-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Release Tag**: ${{ steps.release-version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Release Version**: ${{ steps.release-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "- The main branch has been updated with the next SNAPSHOT version" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub Release has been created with artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- View the release at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release-version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: Skipped (version is not a SNAPSHOT)" >> $GITHUB_STEP_SUMMARY
            echo "- **Current Version**: ${{ steps.current-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Why was this skipped?" >> $GITHUB_STEP_SUMMARY
            echo "The release process only runs when the version ends with -SNAPSHOT." >> $GITHUB_STEP_SUMMARY
            echo "To create a release, ensure the version in pom.xml ends with -SNAPSHOT." >> $GITHUB_STEP_SUMMARY
          fi
